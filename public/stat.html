<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status Layanan API siputzx - Monitoring Realtime REST API</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<style>body{font-family:'Montserrat',sans-serif;background:linear-gradient(145deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);color:#e2e8f0;min-height:100vh}.glass-effect{backdrop-filter:blur(20px);background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);box-shadow:0 10px 40px rgba(0,0,0,0.25)}.chart-wrapper{height:320px;width:100%}.metric-card{transition:all 0.5s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}.metric-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,0.15) 0%,rgba(255,255,255,0) 75%);opacity:0;transition:opacity 0.4s ease;transform:translate(-25%,-25%)}.metric-card:hover{transform:translateY(-8px);box-shadow:0 15px 45px rgba(0,0,0,0.35)}.metric-card:hover::before{opacity:1}.card-icon{transition:all 0.5s cubic-bezier(0.4,0,0.2,1)}.metric-card:hover .card-icon{transform:scale(1.2) rotate(12deg)}@keyframes pulse{0%{transform:scale(1);opacity:0.6}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:0.6}}.live-indicator{animation:pulse 2.5s infinite}.gradient-text{background:linear-gradient(135deg,#60a5fa 0%,#818cf8 50%,#a78bfa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.floating{animation:floating 4s ease-in-out infinite}@keyframes floating{0%{transform:translateY(0px)}50%{transform:translateY(-12px)}100%{transform:translateY(0px)}}.glow{position:absolute;width:100%;height:100%;background:radial-gradient(circle at center,rgba(96,165,250,0.15) 0%,transparent 75%);opacity:0;transition:opacity 0.4s ease}.metric-card:hover .glow{opacity:1}@media (max-width:768px){.chart-wrapper{height:250px}.metric-card{margin-bottom:1rem}.chart-container{margin-bottom:2rem}}.pagination-btn{transition:all 0.3s}.pagination-btn:hover{transform:scale(1.1)}.history-chart{height:250px}.recent-request{transition:all 0.3s ease;border-left:3px solid transparent}.recent-request:hover{border-left-color:#60a5fa;background:rgba(96,165,250,0.05)}.status-success{color:#10b981}.status-error{color:#ef4444}.status-warning{color:#f59e0b}</style>
</head>
<body class="min-h-screen p-4 md:p-8">
<div class="max-w-7xl mx-auto">
<div class="flex flex-col md:flex-row md:items-center justify-between mb-6 md:mb-8 gap-4">
<div><h1 class="text-2xl md:text-4xl font-bold gradient-text mb-2 floating">API Monitoring</h1><p class="text-gray-400 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 live-indicator"></span>Live Dashboard</p></div>
<div class="text-sm text-gray-400 glass-effect px-4 py-2 rounded-lg" id="currentTime"></div>
</div>

<!-- Enhanced Metrics Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Total Requests</h3><p class="text-xl md:text-2xl font-bold text-white" id="totalRequests">0</p></div><div class="card-icon text-sky-500 bg-sky-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-network-wired fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Daily Requests</h3><p class="text-xl md:text-2xl font-bold text-white" id="dailyRequests">0</p></div><div class="card-icon text-violet-500 bg-violet-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-clock fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Requests/Second</h3><p class="text-xl md:text-2xl font-bold text-white" id="requestsPerSecond">0</p></div><div class="card-icon text-emerald-500 bg-emerald-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-gauge-high fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Total Fitur</h3><p class="text-xl md:text-2xl font-bold text-white" id="totalEndpoints">-</p></div><div class="card-icon text-amber-500 bg-amber-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-layer-group fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">API Total</h3><p class="text-xl md:text-2xl font-bold text-white" id="apiTotalRequests">0</p></div><div class="card-icon text-indigo-500 bg-indigo-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-server fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">CPU Usage</h3><p class="text-xl md:text-2xl font-bold text-white" id="cpuUsage">0%</p></div><div class="card-icon text-red-500 bg-red-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-microchip fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Network Down</h3><p class="text-xl md:text-2xl font-bold text-white" id="networkDown">0 MB/s</p></div><div class="card-icon text-cyan-500 bg-cyan-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-download fa-lg"></i></div></div></div>
<div class="metric-card glass-effect rounded-2xl p-4 md:p-6"><div class="glow"></div><div class="flex justify-between items-center"><div><h3 class="text-sm font-medium text-gray-400 mb-1">Network Up</h3><p class="text-xl md:text-2xl font-bold text-white" id="networkUp">0 KB/s</p></div><div class="card-icon text-orange-500 bg-orange-500/10 p-3 md:p-4 rounded-xl"><i class="fas fa-upload fa-lg"></i></div></div></div>
</div>

<!-- Recent API Requests Section -->
<div class="glass-effect rounded-2xl p-4 md:p-6 mb-6 md:mb-8">
<h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
<i class="fas fa-clock text-emerald-500"></i>
Recent API Requests (Last 5)
<span class="text-sm glass-effect px-2 py-1 rounded-lg ml-auto">Real-time</span>
</h2>
<div id="recentRequestsList" class="space-y-2">
<!-- Recent API requests will be populated here -->
</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
<div class="glass-effect rounded-2xl p-4 md:p-6 chart-container"><h2 class="text-lg font-semibold text-white mb-4">Request History (Last 10 Days)</h2><div class="history-chart"><canvas id="historyChart"></canvas></div></div>
<div class="glass-effect rounded-2xl p-4 md:p-6 chart-container"><h2 class="text-lg font-semibold text-white mb-4">Network Usage</h2><div class="chart-wrapper"><canvas id="networkChart"></canvas></div></div>
</div>

<!-- Enhanced Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
<div class="glass-effect rounded-2xl p-4 md:p-6 chart-container"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><h2 class="text-lg font-semibold text-white">System Performance</h2></div><div class="chart-wrapper"><canvas id="systemChart"></canvas></div></div>
<div class="glass-effect rounded-2xl p-4 md:p-6 chart-container"><div class="flex justify-between items-center mb-6"><h2 class="text-lg font-semibold text-white">Request Rate</h2><div class="text-sm glass-effect px-3 py-1 rounded-lg"><i class="fas fa-chart-line mr-2" style="color:#f85149"></i>Real-time</div></div><div class="chart-wrapper"><canvas id="requestChart"></canvas></div></div>
<div class="glass-effect rounded-2xl p-4 md:p-6 chart-container"><div class="flex justify-between items-center mb-6"><h2 class="text-lg font-semibold text-white">Avg Response Time</h2><div class="text-sm glass-effect px-3 py-1 rounded-lg"><i class="fas fa-stopwatch mr-2" style="color:#f472b6"></i>Real-time</div></div><div class="chart-wrapper"><canvas id="responseChart"></canvas></div></div>
</div>

<!-- Enhanced Stats Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
<div class="glass-effect rounded-2xl p-4 md:p-6">
<h2 class="text-lg font-semibold text-white mb-4">Response Time Distribution</h2>
<div class="chart-wrapper"><canvas id="responseDistChart"></canvas></div>
</div>
<div class="glass-effect rounded-2xl p-4 md:p-6">
<h2 class="text-lg font-semibold text-white mb-4">Top User Agents</h2>
<div id="userAgentStats" class="space-y-3">
<!-- User agent stats will be populated here -->
</div>
</div>
</div>

<!-- Request Methods Section -->
<div class="glass-effect rounded-2xl p-4 md:p-6 mb-6 md:mb-8">
<h2 class="text-lg font-semibold text-white mb-4">Request Methods Distribution</h2>
<div class="chart-wrapper"><canvas id="methodChart"></canvas></div>
</div>

<div class="glass-effect rounded-2xl p-4 md:p-6 mt-6 md:mt-8">
<h2 class="text-lg font-semibold text-white mb-4">API Usage Ranking (Last 24 Hours)</h2>
<div class="overflow-x-auto"><table class="w-full text-sm text-gray-400"><thead><tr><th class="px-4 py-2 text-left">Rank</th><th class="px-4 py-2 text-left">Endpoint</th><th class="px-4 py-2 text-left">Total Requests</th><th class="px-4 py-2 text-left">Success</th><th class="px-4 py-2 text-left">Errors</th><th class="px-4 py-2 text-left">Avg Response (ms)</th><th class="px-4 py-2 text-left">Error Rate</th><th class="px-4 py-2 text-left">Success Rate</th></tr></thead><tbody id="apiTableBody"></tbody></table></div>
<div class="flex justify-between items-center mt-4"><button id="prevPage" class="pagination-btn glass-effect px-4 py-2 rounded-lg text-white disabled:opacity-50"><i class="fas fa-chevron-left mr-2"></i>Previous</button><span id="pageInfo" class="text-gray-400"></span><button id="nextPage" class="pagination-btn glass-effect px-4 py-2 rounded-lg text-white disabled:opacity-50">Next<i class="fas fa-chevron-right ml-2"></i></button></div>
</div>
</div>
<script>
let ws,maxPoints=60,itemsPerPage=10;
let memoryData=Array(maxPoints).fill(0),cpuData=Array(maxPoints).fill(0),requestRateData=Array(maxPoints).fill(0),responseTimeData=Array(maxPoints).fill(0),timeLabels=Array(maxPoints).fill(''),networkDownData=Array(maxPoints).fill(0),networkUpData=Array(maxPoints).fill(0),apiStats=[],currentPage=1;

// Store previous values to prevent animation bugs and repetition
let previousStats={
  totalRequests:0,
  requestsPerSecond:0,
  dailyRequests:0,
  totalEndpoints:0,
  apiTotalRequests:0,
  cpuUsage:0,
  networkDown:0,
  networkUp:0,
  memoryUsage:0
};

function connectWebSocket(){const protocol=window.location.protocol==='https:'?'wss':'ws';const wsUrl=`${protocol}://${window.location.host}/ws/monitor`;console.log('Connecting to WebSocket:',wsUrl);ws=new WebSocket(wsUrl);ws.onopen=()=>{console.log('WebSocket connected');document.querySelector('.live-indicator').style.backgroundColor='#10b981';document.body.style.opacity='1'};ws.onmessage=(event)=>{try{const data=JSON.parse(event.data);if(data.stats)handleStatsUpdate(data.stats)}catch(e){console.error('Failed to parse WebSocket message:',e)}};ws.onclose=(event)=>{console.log('WebSocket disconnected:',event.code,event.reason);document.querySelector('.live-indicator').style.backgroundColor='#ef4444';document.body.style.opacity='0.7';setTimeout(connectWebSocket,3000)};ws.onerror=(error)=>{console.error('WebSocket error:',error);document.querySelector('.live-indicator').style.backgroundColor='#ef4444';document.body.style.opacity='0.7'}}

function updateTime(){document.getElementById('currentTime').textContent=new Date().toLocaleString()}setInterval(updateTime,1000);updateTime();

Chart.defaults.color='#94a3b8';Chart.defaults.font.family="'Montserrat',sans-serif";

const commonChartOptions={responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{padding:10}},x:{grid:{display:false},ticks:{padding:10,maxTicksLimit:10}}},plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(15,23,42,0.9)',titleColor:'#e2e8f0',bodyColor:'#94a3b8',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,padding:12,boxPadding:6,usePointStyle:true,callbacks:{label:(context)=>context.dataset.label+': '+context.parsed.y.toFixed(1)}}}};

const systemChart=new Chart(document.getElementById('systemChart'),{type:'line',data:{labels:timeLabels,datasets:[{label:'Memory Usage',data:memoryData,borderColor:'#38bdf8',backgroundColor:'rgba(56,189,248,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true},{label:'CPU Usage',data:cpuData,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true}]},options:{...commonChartOptions,scales:{...commonChartOptions.scales,y:{...commonChartOptions.scales.y,max:100}},plugins:{...commonChartOptions.plugins,legend:{display:true,position:'top',labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle',padding:20,font:{size:12}}}}}});

const requestChart=new Chart(document.getElementById('requestChart'),{type:'line',data:{labels:timeLabels,datasets:[{label:'Requests/Second',data:requestRateData,borderColor:'#f85149',backgroundColor:'rgba(56,189,248,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true}]},options:commonChartOptions});

const responseChart=new Chart(document.getElementById('responseChart'),{type:'line',data:{labels:timeLabels,datasets:[{label:'Avg Response Time (ms)',data:responseTimeData,borderColor:'#f472b6',backgroundColor:'rgba(244,114,182,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true}]},options:{...commonChartOptions,scales:{...commonChartOptions.scales,y:{...commonChartOptions.scales.y,ticks:{callback:value=>value+' ms'}}}}});

const historyChart=new Chart(document.getElementById('historyChart'),{type:'bar',data:{labels:[],datasets:[{label:'Total Requests',data:[],backgroundColor:'rgba(96,165,250,0.8)',borderColor:'#60a5fa',borderWidth:1},{label:'API Requests',data:[],backgroundColor:'rgba(129,140,248,0.8)',borderColor:'#818cf8',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{padding:10}},x:{grid:{display:false},ticks:{padding:10,maxRotation:45}}},plugins:{legend:{display:true,position:'top',labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle',padding:20,font:{size:12}}},tooltip:{backgroundColor:'rgba(15,23,42,0.9)',titleColor:'#e2e8f0',bodyColor:'#94a3b8',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,padding:12,boxPadding:6,usePointStyle:true}}}});

const networkChart=new Chart(document.getElementById('networkChart'),{type:'line',data:{labels:timeLabels,datasets:[{label:'Download',data:networkDownData,borderColor:'#06b6d4',backgroundColor:'rgba(6,182,212,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true},{label:'Upload',data:networkUpData,borderColor:'#fb923c',backgroundColor:'rgba(251,146,60,0.1)',tension:0.4,borderWidth:2,pointRadius:0,fill:true}]},options:{...commonChartOptions,plugins:{...commonChartOptions.plugins,legend:{display:true,position:'top',labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle',padding:20,font:{size:12}}}}}});

const responseDistChart=new Chart(document.getElementById('responseDistChart'),{type:'doughnut',data:{labels:['Fast (<10000ms)','Medium (10000-30000ms)','Slow (30000-60000ms)','Very Slow (>60000ms)'],datasets:[{data:[0,0,0,0],backgroundColor:['#10b981','#f59e0b','#f97316','#ef4444'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'bottom',labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle',padding:15,font:{size:11}}},tooltip:{backgroundColor:'rgba(15,23,42,0.9)',titleColor:'#e2e8f0',bodyColor:'#94a3b8',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,padding:12}}}});

const methodChart=new Chart(document.getElementById('methodChart'),{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'bottom',labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle',padding:15,font:{size:11}}},tooltip:{backgroundColor:'rgba(15,23,42,0.9)',titleColor:'#e2e8f0',bodyColor:'#94a3b8',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,padding:12}}}});

function updateTimeSeriesData(newMemory,newCPU,newRequestRate,newResponseTime,newDownload,newUpload){
  const now=new Date().toLocaleTimeString();
  
  timeLabels.shift();
  timeLabels.push(now);
  
  memoryData.shift();
  memoryData.push(parseFloat(newMemory)||0);
  
  cpuData.shift();
  cpuData.push(parseFloat(newCPU)||0);
  
  requestRateData.shift();
  requestRateData.push(parseFloat(newRequestRate)||0);
  
  responseTimeData.shift();
  responseTimeData.push(parseFloat(newResponseTime)||0);
  
  networkDownData.shift();
  networkDownData.push(parseFloat(newDownload)||0);
  
  networkUpData.shift();
  networkUpData.push(parseFloat(newUpload)||0);
  
  return{
    labels:timeLabels,
    memory:memoryData,
    cpu:cpuData,
    requests:requestRateData,
    responseTime:responseTimeData,
    download:networkDownData,
    upload:networkUpData
  }
}

function animateValue(element,start,end,duration,unit=''){
  if(!element) return;
  
  const range=end-start;
  if(Math.abs(range) < 1){
    element.textContent=end.toLocaleString()+unit;
    return;
  }
  
  const stepTime=Math.abs(Math.floor(duration/Math.abs(range)));
  const startTime=new Date().getTime();
  const endTime=startTime+duration;
  let timer;
  
  function run(){
    const now=new Date().getTime();
    const remaining=Math.max((endTime-now)/duration,0);
    const value=Math.round(end-remaining*range);
    element.textContent=value.toLocaleString()+unit;
    if(value===end) clearInterval(timer);
  }
  
  timer=setInterval(run,stepTime);
  run();
}

function updateMetricCard(elementId,newValue,oldValue=0,unit=''){
  const element=document.getElementById(elementId);
  if(!element) return;
  
  // Special handling for CPU - realtime direct update but check for changes to prevent repetition
  if(elementId === 'cpuUsage') {
    const currentDisplayed = parseFloat(element.textContent.replace('%', '')) || 0;
    const newCpuValue = parseFloat(newValue) || 0;
    
    // Only update if value actually changed (prevent repetition)
    if(Math.abs(newCpuValue - currentDisplayed) >= 0.1) {
      element.textContent = newCpuValue.toFixed(1) + unit;
    }
    return;
  }
  
  // Use smooth animation for other metrics
  animateValue(element, oldValue, newValue, 500, unit);
}

function renderRecentRequests(recentRequests){
  const container=document.getElementById('recentRequestsList');
  if(!container||!recentRequests)return;
  
  // Filter only API requests (endpoints starting with /api/)
  const apiRequests = recentRequests.filter(req => req.endpoint && req.endpoint.startsWith('/api/'));
  
  container.innerHTML='';
  
  if(apiRequests.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 py-4">No recent API requests</div>';
    return;
  }
  
  apiRequests.forEach((req,index)=>{
    const timeAgo=Math.floor((Date.now()-req.timestamp)/1000);
    const timeText=timeAgo<60?`${timeAgo}s ago`:timeAgo<3600?`${Math.floor(timeAgo/60)}m ago`:`${Math.floor(timeAgo/3600)}h ago`;
    const statusClass=req.statusCode>=200&&req.statusCode<300?'status-success':req.statusCode>=500?'status-error':'status-warning';
    
    const div=document.createElement('div');
    div.className='recent-request glass-effect p-3 rounded-lg flex items-center justify-between';
    div.innerHTML=`
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full ${req.statusCode>=200&&req.statusCode<300?'bg-emerald-500':req.statusCode>=500?'bg-red-500':'bg-yellow-500'}"></div>
        <div>
          <div class="text-sm font-medium text-white">${req.method} ${req.endpoint}</div>
          <div class="text-xs text-gray-400">${req.maskedIp} • ${req.userAgent}</div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-sm ${statusClass} font-medium">${req.statusCode}</div>
        <div class="text-xs text-gray-400">${req.duration}ms • ${timeText}</div>
      </div>
    `;
    container.appendChild(div);
  });
}

function renderUserAgentStats(userAgentData){
  const container=document.getElementById('userAgentStats');
  if(!container||!userAgentData)return;
  
  const sortedAgents=Object.entries(userAgentData).sort(([,a],[,b])=>b-a).slice(0,5);
  container.innerHTML='';
  
  sortedAgents.forEach(([agent,count])=>{
    const div=document.createElement('div');
    div.className='flex items-center justify-between p-2 glass-effect rounded-lg';
    div.innerHTML=`
      <div class="flex items-center gap-2">
        <i class="fas fa-globe text-blue-400"></i>
        <span class="text-white">${agent}</span>
      </div>
      <span class="text-gray-400">${count.toLocaleString()}</span>
    `;
    container.appendChild(div);
  });
}

function renderApiTable(){
  const start=(currentPage-1)*itemsPerPage;
  const end=start+itemsPerPage;
  const slicedStats=apiStats.slice(start,end);
  const tbody=document.getElementById('apiTableBody');
  
  tbody.innerHTML='';
  slicedStats.forEach(([endpoint,data],index)=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td class="px-4 py-2">${start+index+1}</td>
      <td class="px-4 py-2">${endpoint.replace(/_/g,'/')}</td>
      <td class="px-4 py-2">${data.totalRequests.toLocaleString()}</td>
      <td class="px-4 py-2">${data.success.toLocaleString()}</td>
      <td class="px-4 py-2">${data.errors.toLocaleString()}</td>
      <td class="px-4 py-2">${data.avgResponseTime}</td>
      <td class="px-4 py-2">${data.errorRate}%</td>
      <td class="px-4 py-2">${data.successRate}%</td>
    `;
    tbody.appendChild(row);
  });
  
  const totalPages=Math.ceil(apiStats.length/itemsPerPage);
  document.getElementById('pageInfo').textContent=`Page ${currentPage} of ${totalPages}`;
  document.getElementById('prevPage').disabled=currentPage===1;
  document.getElementById('nextPage').disabled=currentPage===totalPages;
}

function updateHistoryChart(dailyData,apiDailyData){
  const dates=Object.keys(dailyData).slice(-10).map(date=>new Date(date).toLocaleDateString());
  const totalRequests=Object.keys(dailyData).slice(-10).map(date=>dailyData[date]);
  const apiRequests=Object.keys(apiDailyData).slice(-10).map(date=>apiDailyData[date]||0);
  
  historyChart.data.labels=dates;
  historyChart.data.datasets[0].data=totalRequests;
  historyChart.data.datasets[1].data=apiRequests;
  historyChart.update('none');
}

function handleStatsUpdate(stats){
  // Update metrics with proper value preservation and animation
  updateMetricCard('totalRequests',stats.requests.total,previousStats.totalRequests);
  previousStats.totalRequests=stats.requests.total;
  
  updateMetricCard('totalEndpoints',stats.system.totalEndpoints,previousStats.totalEndpoints);
  previousStats.totalEndpoints=stats.system.totalEndpoints;
  
  updateMetricCard('requestsPerSecond',parseFloat(stats.requests.perSecond),previousStats.requestsPerSecond);
  previousStats.requestsPerSecond=parseFloat(stats.requests.perSecond);
  
  updateMetricCard('apiTotalRequests',stats.requests.api.total,previousStats.apiTotalRequests);
  previousStats.apiTotalRequests=stats.requests.api.total;

  const today=new Date().toISOString().split('T')[0];
  const dailyRequestCount=stats.requests.daily?.[today]||0;
  updateMetricCard('dailyRequests',dailyRequestCount,previousStats.dailyRequests);
  previousStats.dailyRequests=dailyRequestCount;

  // CPU usage - REALTIME update with no delay, but prevent repetition
  const newCpuUsage = parseFloat(stats.system.cpu.usage || 0);
  updateMetricCard('cpuUsage', newCpuUsage, previousStats.cpuUsage, '%');
  previousStats.cpuUsage = newCpuUsage;

  // Update network stats - realtime like before
  if(stats.network){
    document.getElementById('networkDown').textContent=stats.network.download.speed||'0 MB/s';
    document.getElementById('networkUp').textContent=stats.network.upload.speed||'0 KB/s';
    
    previousStats.networkDown=stats.network.download.speedRaw||0;
    previousStats.networkUp=stats.network.upload.speedRaw||0;
  }

  // Store memory usage
  previousStats.memoryUsage = parseFloat(stats.system.memory.usagePercent || 0);

  // Update time series data with realtime values
  const timeSeriesData=updateTimeSeriesData(
    previousStats.memoryUsage,
    newCpuUsage, // Use realtime CPU value for charts
    stats.requests.perSecond,
    stats.overallAvgResponseTime,
    previousStats.networkDown,
    previousStats.networkUp
  );

  // Update charts
  systemChart.data.labels=timeSeriesData.labels;
  systemChart.data.datasets[0].data=timeSeriesData.memory;
  systemChart.data.datasets[1].data=timeSeriesData.cpu;
  systemChart.update('none');

  requestChart.data.labels=timeSeriesData.labels;
  requestChart.data.datasets[0].data=timeSeriesData.requests;
  requestChart.update('none');

  responseChart.data.labels=timeSeriesData.labels;
  responseChart.data.datasets[0].data=timeSeriesData.responseTime;
  responseChart.update('none');

  networkChart.data.labels=timeSeriesData.labels;
  networkChart.data.datasets[0].data=timeSeriesData.download;
  networkChart.data.datasets[1].data=timeSeriesData.upload;
  networkChart.update('none');

  // Update history chart
  if(stats.requests.daily&&stats.requests.api.daily){
    updateHistoryChart(stats.requests.daily,stats.requests.api.daily);
  }

  // Update enhanced stats
  if(stats.enhanced){
    renderRecentRequests(stats.enhanced.recentRequests);
    renderUserAgentStats(stats.enhanced.topUserAgents);
    
    // Update response time distribution
    if(stats.enhanced.responseTimeDistribution){
      const dist=stats.enhanced.responseTimeDistribution;
      responseDistChart.data.datasets[0].data=[dist.fast,dist.medium,dist.slow,dist.verySlow];
      responseDistChart.update('none');
    }
    
    // Update method distribution
    if(stats.enhanced.methodDistribution){
      const methods=Object.keys(stats.enhanced.methodDistribution);
      const counts=Object.values(stats.enhanced.methodDistribution);
      methodChart.data.labels=methods;
      methodChart.data.datasets[0].data=counts;
      methodChart.update('none');
    }
  }

  // Update API stats table
  apiStats=Object.entries(stats.apiStats)
    .filter(([_,data])=>data.totalRequests>0)
    .sort((a,b)=>b[1].totalRequests-a[1].totalRequests);
  renderApiTable();
}

// Event listeners
document.getElementById('prevPage').addEventListener('click',()=>{
  if(currentPage>1){
    currentPage--;
    renderApiTable();
  }
});

document.getElementById('nextPage').addEventListener('click',()=>{
  if(currentPage<Math.ceil(apiStats.length/itemsPerPage)){
    currentPage++;
    renderApiTable();
  }
});

// Handle window resize
let resizeTimeout;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimeout);
  resizeTimeout=setTimeout(()=>{
    [systemChart,requestChart,responseChart,historyChart,networkChart,responseDistChart,methodChart].forEach(chart=>chart.resize());
  },250);
});

// Handle visibility change
document.addEventListener('visibilitychange',()=>{
  const charts=[systemChart,requestChart,responseChart,historyChart,networkChart,responseDistChart,methodChart];
  if(document.hidden){
    charts.forEach(chart=>chart.stop());
  }else{
    charts.forEach(chart=>{
      chart.start();
      chart.update('none');
    });
  }
});

// Initialize WebSocket connection
connectWebSocket();
</script>
</body>
</html>
